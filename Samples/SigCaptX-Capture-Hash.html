<!--
/* ************************************************************************** */
  SigCaptX-Capture-Hash.html
   
  Cross browser Signature Capture test

  Demonstrates standard signature capture using SigCaptX with the DynamicCapture method call
  and use of the Hash object to embed a hash of a couple of values taken from text boxes in the signature object 
  and then verify it
  
  Copyright (c) 2018 Wacom Co. Ltd. All rights reserved.
  
   v4.0
  
/* ************************************************************************** */
-->
<!DOCTYPE html>
<html>
  <head>
    <title>SigCaptX-Capture-Hash</title>
    <script src="wgssSigCaptX.js"></script>
    <script src="base64.js"></script>
	  <script src="SigCaptX-Utils.js"></script>
	  <script src="SigCaptX-SessionControl.js"></script>
    <script type="text/javascript">
      
var wgssSignatureSDK = null;
var sigObj = null;
var sigCtl = null;
var dynCapt = null;

/* wizardEventController is the main event handler for the wizard script */
var wizardEventController =
{
  body_onload : function()
  {
    clearTextBox();
    actionWhenRestarted();
  },
  
  start_stop : function()
  {
    if( scriptIsRunning ) 
    {
      wizardEventController.stop();
    }
    else
    {
      wizardStart(3);
    }
  },
  
  stop : function()
  {
    if( !scriptIsRunning ) 
    {
      print("Script not running");
    }
    else
    {
      stopScript();
    }
  },
  
  script_Completed : function()
  {
    print("Script completed");
    showSignature();
  },
  
  script_Cancelled : function()
  {
    print("Script cancelled");
    wizardEventController.stop();
  }
}

function capture()
{
  if(!wgssSignatureSDK.running || null == dynCapt)
  {
    print("Session error. Restarting the session.");
    actionWhenRestarted(window.Capture);
    return;
  }
  
  var hash = new wgssSignatureSDK.Hash(onHashConstructor);
  
  function onHashConstructor(hashV, status)
  {
    if(wgssSignatureSDK.ResponseStatus.OK == status)
    {
      GetHash(hash, onGetInitialHash);
    }
    else
    {
      print("Hash Constructor error: " + status);
      if(wgssSignatureSDK.ResponseStatus.INVALID_SESSION == status)
      {
        print("Error: invalid session. Restarting the session.");
        actionWhenRestarted(window.Capture);
      }
    }
  }
  
  function onGetInitialHash()
  {
    dynCapt.Capture(sigCtl, "who", "why", hash, null, onDynCaptCapture);
  }

  function onDynCaptCapture(dynCaptV, SigObjV, status)
  {
    switch( status ) 
    {
      case wgssSignatureSDK.DynamicCaptureResult.DynCaptOK:
        sigObj = SigObjV;
        print("Signature captured successfully");
        var flags = wgssSignatureSDK.RBFlags.RenderOutputPicture |
                    wgssSignatureSDK.RBFlags.RenderColor24BPP;
        var imageBox = document.getElementById("imageBox");
        sigObj.RenderBitmap("bmp", imageBox.clientWidth, imageBox.clientHeight, 0.7, 0x00000000, 0x00FFFFFF, flags, 0, 0, onRenderBitmap);
        break;
      case wgssSignatureSDK.DynamicCaptureResult.DynCaptCancel:
        print("Signature capture cancelled");
        break;
      case wgssSignatureSDK.DynamicCaptureResult.DynCaptPadError:
        print("No capture service available");
        break;
      case wgssSignatureSDK.DynamicCaptureResult.DynCaptError:
        print("Tablet Error");
        break;
      case wgssSignatureSDK.DynamicCaptureResult.DynCaptNotLicensed:
        print("No valid Signature Capture licence found");
        break;
      default: 
        print("Capture Error " + status);
        break;
      }
  }
  
  function onRenderBitmap(sigObjV, bmpObj, status) 
  {
    if(wgssSignatureSDK.ResponseStatus.OK == status) 
    {
      var imageBox = document.getElementById("imageBox");
      if(null == imageBox.firstChild)
      {
        imageBox.appendChild(bmpObj.image);
      }
      else
      {
        imageBox.replaceChild(bmpObj.image, imageBox.firstChild);
      }
    } 
    else 
    {
      print("Signature Render Bitmap error: " + status);
    }
  }
  
}

function displaySignatureDetails(sigObj)
{
  if(!wgssSignatureSDK.running || null == sigObj)
  {
    print("Session error. Restarting the session." );
    actionWhenRestarted(window.displaySignatureDetails);
    return;
  }
  sigObj.GetIsCaptured(onGetIsCaptured);
  
  function onGetIsCaptured(sigObj, isCaptured, status)
  {
    if(wgssSignatureSDK.ResponseStatus.OK == status) 
    {
      if(!isCaptured)
      {
        print("No signature has been captured yet." );
        return;
      }
      sigObj.GetWho(onGetWho);
    }
    else 
    {
      print("Signature GetWho error: " + status);
      if(wgssSignatureSDK.ResponseStatus.INVALID_SESSION == status)
      {
        print("Session error. Restarting the session.");
        actionWhenRestarted(window.displaySignatureDetails);
      }
    }
  }
  
  function onGetWho(sigObjV, who, status) 
  {
    if(wgssSignatureSDK.ResponseStatus.OK == status) 
    {
      print("  Name:   " + who);
      var tz = wgssSignatureSDK.TimeZone.TimeLocal;
      sigObj.GetWhen(tz, onGetWhen);
    } 
    else 
    {
      print("Signature GetWho error: " + status);
    }
  }
  
  function onGetWhen(sigObjV, when, status) 
  {
    if(wgssSignatureSDK.ResponseStatus.OK == status) 
    {
      print("  Date:   " + when.toString() );
      sigObj.GetWhy(onGetWhy);
    } 
    else 
    {
      print("Signature GetWhen error: " + status);
    }
  }
  
  function onGetWhy(sigObjV, why, status) 
  {
    if(wgssSignatureSDK.ResponseStatus.OK == status) 
    {
      print("  Reason: " + why);
    } 
    else 
    {
      print("Signature GetWhy error: " + status);
    }
  }
  
}

function GetHash(hash, callback)
{
  print("Creating hash:");
  hash.Clear(onClear);
  
  function onClear(hashV, status)
  {
    if(wgssSignatureSDK.ResponseStatus.OK == status) 
    {
      hash.PutType(wgssSignatureSDK.HashType.HashMD5, onPutType);
    } 
    else 
    {
      print("Hash Clear error: " + status);
    }
  }
  
  function onPutType(hashV, status)
  {
    if(wgssSignatureSDK.ResponseStatus.OK == status) 
    {
      var vFname = new wgssSignatureSDK.Variant();
      vFname.Set(document.getElementById("fname").value);
      hash.Add(vFname, onAddFname);
    } 
    else 
    {
      print("Hash PutType error: " + status);
    }
  }
  
  function onAddFname(hashV, status)
  {
    if(wgssSignatureSDK.ResponseStatus.OK == status) 
    {
      var vLname = new wgssSignatureSDK.Variant();
      vLname.Set(document.getElementById("lname").value);
      hash.Add(vLname, onAddLname);
    } 
    else 
    {
      print("Hash Add error: " + status);
    }
  }
  
  function onAddLname(hashV, status)
  {
    if(wgssSignatureSDK.ResponseStatus.OK == status) 
    {
      callback();
    } 
    else 
    {
      print("Hash Add error: " + status);
    }
  }
}

function verifySignedData()
{
  print("Verifying signed data...");
  if(null == sigObj)
  {
    actionWhenRestarted(window.VerifySig);
    return;
  }
  var hash = null;
  sigObj.GetIsCaptured(onGetIsCaptured);
  
  function onGetIsCaptured(sigObjV, isCaptured, status)
  {
    if(wgssSignatureSDK.ResponseStatus.OK == status)
    {
      if(isCaptured)
      {
        hash = new wgssSignatureSDK.Hash(onHashConstructor);
      }
      else
      {
        print("Signature not captured");
      }
    }
    else
    {
      print("GetIsCaptured error: " + status);
      if(wgssSignatureSDK.ResponseStatus.INVALID_SESSION == status)
      {
        print("Error: invalid session. Restarting the session.");
        actionWhenRestarted(window.VerifySig);
      }
    }
  }  
  
  function onHashConstructor(hashV, status)
  {
    if(wgssSignatureSDK.ResponseStatus.OK == status)
    {
      GetHash(hash, onGetHashForVerification);
    }
    else
    {
      print("Hash Constructor error: " + status);
    }
  }
  
  function onGetHashForVerification()
  {
    sigObj.CheckSignedData(hash, onCheckSignedData);
  }
  
  function onCheckSignedData(hash, status)
  {
    print("Verify result: " + status);
    if(wgssSignatureSDK.SignedData.DataGood == status)
    {
      print("Signed Data OK");
    }
    else
    {
      print("Signed Data Has Changed");
    }
  }
}
    </script>
  </head>
  <body onload="wizardEventController.body_onload()">
    <div style="width:100%">
      <h2>Test Signature Control with Hash of Signatory's name</h2>
      <table style="padding: 10px 90px;">
        <tr>
        <td></td><td></td><td>Data included in the hash:</td>
        </tr>
        <tr>
          <td rowspan="2">
            <div id="imageBox" class="boxed" style="height:35mm;width:60mm; border:1px solid #d3d3d3;" ondblclick="displaySignatureDetails(sigObj)" title="Double-click a signature to display its details">
            </div>
          </td>
          <td  style="padding: 10px 50px;">
            <input type="button" value="Capture" style="height:10mm;width:35mm" onclick="capture()"
            title="Starts signature capture" />
          </td>
          <td>
          First name: <input type="text" id="fname" value="John"/>
          </td>
        </tr>
        <tr>
          <td style="padding: 10px 50px;">
            <input type="button" value="Verify" style="height:10mm;width:35mm" onclick="verifySignedData()"
            title="Checks the signature hash" />
          </td>
          <td>
          Last name: <input type="text" id="lname" value="Smith"/>
          </td>
        </tr>
      </table>
        <br/>
            <textarea cols="125" rows="15" id="txtDisplay"></textarea>
    </div>
  </body>
</html>
